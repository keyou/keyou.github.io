---
title: ä¸€æ¬¡ Android åº”ç”¨æ¸²æŸ“æ€§èƒ½åˆ†ææ¡ˆä¾‹
tags:
  - android
  - grahpics
  - perf
---

é¡¹ç›®ä¸­å‘ç°ï¼Œåœ¨æµè§ˆå™¨ä¸­çš„ Canvas ä¸Šä¹¦å†™çš„å»¶è¿Ÿ (lag) å¾ˆé«˜ï¼Œè¿™é‡Œçš„å»¶è¿ŸæŒ‡çš„æ˜¯æ‰‹æŒ‡åˆ°å±å¹•ä¸Šç¬”è¿¹çš„æœ€æœ«ç«¯çš„å»¶è¿Ÿï¼Œä¸‹é¢è°ƒæŸ¥é—®é¢˜çš„åŸå› ï¼ŒæœŸæœ›æ‰¾åˆ°ä¸€ç§é€šç”¨çš„è§£å†³æ–¹æ¡ˆã€‚

é—®é¢˜å¯èƒ½å‡ºåœ¨ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹ï¼š

1. æµè§ˆå™¨æœ¬èº«çš„äº‹ä»¶ä¼ é€’å’Œæ¸²æŸ“æµæ°´çº¿ï¼›
2. æµè§ˆå™¨ä½¿ç”¨çš„ Skia å›¾å½¢åº“ï¼›
3. æµè§ˆå™¨å’Œ Android æ¸²æŸ“çš„å¯¹æ¥æ–¹å¼ï¼›
4. è®¾å¤‡çš„ GPU ç¡¬ä»¶ã€‚
5. æ“ä½œç³»ç»Ÿæœ¬èº«ï¼›

å› æ­¤ï¼Œå†™äº†ä¸€ä¸ª Demoï¼ˆ[demo_android_skia](https://github.com/keyou/chromium_demo/tree/c/80.0.3987/demo_android/demo_android_skia)ï¼‰ æ¥æ¨¡æ‹Ÿæµè§ˆå™¨åœ¨ Android ä¸Šçš„æ¸²æŸ“ï¼Œç”¨äºåŠ æ·±å¯¹ Chromium æ¸²æŸ“çš„ç†è§£ï¼Œä¹Ÿæ–¹ä¾¿åç»­çš„è°ƒè¯•ã€‚ä¸ºäº†èƒ½å¤Ÿå®šé‡çš„åˆ†æç¨‹åºçš„æ€§èƒ½ï¼Œåœ¨ Demo ä¸­æ·»åŠ äº† [Trace]({% post_url 2020-05-20-tracing %}) æœºåˆ¶ï¼Œç„¶åæŠ“åˆ°æ€§èƒ½æ•°æ®å¦‚ä¸‹ï¼š

![Trace](/data/2020-06-03-11-54-04-trace-skia.png)

å±€éƒ¨æ”¾å¤§ï¼š

![Trace2](/data/2020-06-03-11-58-46.png)

æœ‰ä»¥ä¸‹å‘ç°ï¼š

1. ä¸»çº¿ç¨‹ï¼ˆ23118ï¼Œå¯¹åº” Andorid ä¸­çš„ UI çº¿ç¨‹ï¼‰ä¸­çš„ `Looper.dispatch: android.view.Choreographer$FrameHandler(android.view.Choreographer$FrameDisplayEventReceiver` å ç”¨äº†å¤§é‡çš„æ—¶é—´ï¼Œç”±äºä»–è´Ÿè´£ Touch äº‹ä»¶çš„åˆ†å‘ï¼Œå› æ­¤è¿™å¯èƒ½å½±å“ Touch äº‹ä»¶çš„åˆ†å‘é€Ÿåº¦ï¼›
2. `Looper.dispatch:...` çš„ `Wall Duration` æ˜¯ 27.9ms, è€Œ `CPU Duration` åªæœ‰ 6.8ms, è¯´æ˜æœ‰å¤§é‡çš„æ—¶é—´éƒ½ä¸æ˜¯æ¶ˆè€—åœ¨ CPU ä¸Šï¼›
3. ç”±äºæ²¡æœ‰è¶³å¤Ÿçš„ Touch äº‹ä»¶ï¼Œå› æ­¤è´Ÿè´£æˆ‘ä»¬ç¨‹åºæ¸²æŸ“çš„`RenderThread`å¾ˆç©ºé—²ï¼ˆè¿™ä¸ªæ˜¯è‡ªå®šä¹‰çš„çº¿ç¨‹ï¼Œåæ¥å‘ç°å‘½åå’Œ Android åŸæœ¬çš„æ¸²æŸ“çº¿ç¨‹é‡åäº†ï¼Œå› æ­¤åç»­è¿™ä¸ªçº¿ç¨‹è¢«é‡å‘½åä¸ºäº† `DemoRender`)ï¼›

æ‰€ä»¥è¦ç ”ç©¶ `Looper.dispatch: android.view.Choreographer$FrameHandler(android.view.Choreographer$FrameDisplayEventReceiver` è¿™ä¸ª Trace æ˜¯æ€ä¹ˆæ¥çš„ï¼Œçœ‹èƒ½ä¸èƒ½æ·»åŠ æ›´è¯¦ç»†çš„ Trace ä¿¡æ¯æ¥å®šä½æ˜¯ä»€ä¹ˆé€ æˆäº†å®ƒå ç”¨é‚£ä¹ˆå¤šçš„æ—¶é—´ã€‚

## Looper.dispatch:* çš„æ¥æº

Android ç³»ç»Ÿå±‚çš„ `android.os.Looper` ç±»è´Ÿè´£çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯ï¼Œå®ƒç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç³»ç»Ÿçš„è§¦æ‘¸ï¼Œæ¸²æŸ“ç­‰æ¶ˆæ¯ç­‰éƒ½æ˜¯åœ¨è¿™é‡Œåˆ†å‘ç»™åˆ° Appï¼Œå®ƒå…è®¸å¤–éƒ¨æ³¨å†Œä¸€ä¸ª `android.util.Printer` å¯¹è±¡ï¼Œç”¨æ¥æ‰“å°æ¶ˆæ¯çš„åˆ†å‘æ—¥å¿—ï¼š

```java
// frameworks/base/core/java/android/os/Looper.java
public static void loop() {
  // ...
  for (;;) {
      Message msg = queue.next(); // might block
      if (msg == null) {
          // No message indicates that the message queue is quitting.
          return;
      }

      // è¿™ä¸ª logging ç”¨æ¥æ‰“å°æ¶ˆæ¯åˆ†å‘æ—¥å¿—
      final Printer logging = me.mLogging;
      if (logging != null) {
          logging.println(">>>>> Dispatching to " + msg.target + " " +
                  msg.callback + ": " + msg.what);
      }
      // ...
      if (logging != null) {
          logging.println("<<<<< Finished to " + msg.target + " " + msg.callback);
      }
      // ...
  }
}
```

å½“å¼€å¯æˆ‘ä»¬ç¨‹åºçš„ TraceEvent çš„æ—¶å€™ï¼Œä¼šå‘ Android çš„ä¸»æ¶ˆæ¯å¾ªç¯ Looper ä¸­æ³¨å†Œä¸€ä¸ª `android.util.Printer` å¯¹è±¡ï¼Œè¿™ä¸ª Printer è´Ÿè´£å°† Looper çš„æ—¥å¿—è¾“å‡ºå¯¹æ¥åˆ° TraceEvent æœºåˆ¶ï¼š

```java
// base/android/java/src/org/chromium/base/TraceEvent.java
@CalledByNative
public static void setEnabled(boolean enabled) {
  // ...
  ThreadUtils.getUiThreadLooper().setMessageLogging(
          enabled ? LooperMonitorHolder.sInstance : null);
}

private static final class LooperMonitorHolder {
    private static final BasicLooperMonitor sInstance =
            CommandLine.getInstance().hasSwitch(BaseSwitches.ENABLE_IDLE_TRACING)
            ? new IdleTracingLooperMonitor() : new BasicLooperMonitor();
}
```

æ‰€ä»¥è¿™å°±è§£é‡Šäº† `Looper.dispatch: android.view.Choreographer$FrameHandler(android.view.Choreographer$FrameDisplayEventReceiver` çš„æ¥æºã€‚ä½†æ˜¯è¿˜æ²¡æœ‰è§£é‡Šä¸ºä»€ä¹ˆä»–å­˜åœ¨å¤§é‡çš„æ—¶é—´å¤„äºéæ´»è·ƒçŠ¶æ€ï¼Œç„¶åå¼€å§‹ç ”ç©¶ Android çš„ `Choreographer` æœºåˆ¶ï¼Œç®€å•æ¥è¯´å®ƒåœ¨ Android ç³»ç»Ÿä¸­è´Ÿè´£æ¸²æŸ“/äº¤äº’/äº‹ä»¶ç­‰çš„è°ƒåº¦ï¼Œç†Ÿæ‚‰äº†å®ƒçš„æœºåˆ¶ä¹‹åäº†è§£åˆ°ä¸Šé¢è¿™æ¡ä¿¡æ¯è¡¨ç¤º`Choreographer`æ”¶åˆ°äº† vsync ä¿¡å·åœ¨è¿›è¡Œ vsync çš„è°ƒåº¦ï¼Œç»è¿‡è¿½è¸ªä»£ç å‘ç°å®ƒé€šè¿‡ FrameDisplayEventReceicer æœ€ç»ˆè§¦å‘äº† Frame çš„é‡ç»˜ï¼š

```java
// frameworks/base/core/java/android/view/Choreographer.java
 void doFrame(long frameTimeNanos, int frame) {
        final long startNanos;
        synchronized (mLock) {
        // ...
        try {
            Trace.traceBegin(Trace.TRACE_TAG_VIEW, "Choreographer#doFrame");
            AnimationUtils.lockAnimationClock(frameTimeNanos / TimeUtils.NANOS_PER_MS);

            mFrameInfo.markInputHandlingStart();
            doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos);

            mFrameInfo.markAnimationsStart();
            doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);
            doCallbacks(Choreographer.CALLBACK_INSETS_ANIMATION, frameTimeNanos);

            mFrameInfo.markPerformTraversalsStart();
            doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);

            doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);
        } finally {
            AnimationUtils.unlockAnimationClock();
            Trace.traceEnd(Trace.TRACE_TAG_VIEW);
        }
      // ...
    }
 }
```

è¿™æ®µä»£ç ä¸­å¯ä»¥å‘ç°å…¶ä¸­æœ‰æ·»åŠ  Traceï¼Œå› æ­¤ç ”ç©¶å¦‚ä½•å¼€å¯Androidç³»ç»Ÿçš„ Traceï¼Œç¡®è®¤åœ¨ `Choreographer#doFrame` ä¸­éƒ½è¿›è¡Œäº†å“ªäº›æ“ä½œã€‚

ç»è¿‡ç ”ç©¶ï¼Œå‘ç°ä»¥ä¸Šä»£ç æ˜¯ä¸€ç§ systrace æœºåˆ¶ã€‚

## system trace

å®ƒæ˜¯ä¸€ç§åŸºäº Linux å†…æ ¸çš„ [ftrace](https://www.kernel.org/doc/Documentation/trace/ftrace.txt) å®ç°çš„æµç¨‹è¿½è¸ªæœºåˆ¶ï¼Œå¯ä»¥æ”¶é›†ç³»ç»Ÿå…¨å±€çš„æ€§èƒ½æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ systrace.py è„šæœ¬å¼€å¯ï¼Œæˆ–è€…ä»ç³»ç»Ÿä¸­ç›´æ¥å¯åŠ¨ï¼Œè·å–åˆ°çš„æ•°æ®å¯ä»¥ç”Ÿæˆç±»ä¼¼ chrome://tracing é‚£æ ·çš„åˆ†æç»“æœã€‚å¯ä»¥ä½¿ç”¨ `android.os.Trace` åœ¨è‡ªå·±çš„ç¨‹åºä¸­æ·»åŠ æ–°çš„è¿½è¸ªç‚¹ã€‚å®ƒçš„å¥½å¤„æ˜¯ä¸ä¾èµ– Android Studioï¼Œè€Œä¸”å¯ä»¥æ”¶é›†åˆ°ç³»ç»Ÿçº§çš„ä¿¡æ¯ã€‚

adb è¿æ¥ä»¥åï¼Œç›´æ¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥è·å–æŒ‡å®šåº”ç”¨çš„ system trace, ç»“æœæ–‡ä»¶ä¼šè¢«ä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ç”Ÿæˆçš„ html æ–‡ä»¶å³å¯è¿›è¡Œè°ƒè¯•ã€‚

```shell
python systrace.py -a com.example.myapp -b 16384 -o my_systrace_report.html sched freq idle am wm gfx view binder_driver hal dalvik camera input res
```

> systrace å‘½ä»¤çš„ä½¿ç”¨è§ï¼š <https://developer.android.com/topic/performance/tracing/command-line#app-trace>

ä½†æ˜¯å®ƒåªèƒ½æŠ“åˆ°ç³»ç»ŸåŸ‹å¥½çš„ Trace ç‚¹ï¼Œå¦‚æœè¦æŠ“åˆ°è‡ªå·±ä»£ç çš„æ•°æ®ï¼Œéœ€è¦ç»™è‡ªå·±çš„ä»£ç æ·»åŠ è¿½è¸ªç‚¹ï¼Œå¯ä»¥æŒ‰ç…§è¿™é‡Œä»‹ç»çš„æ–¹æ³•ç»™è‡ªå·±çš„ç¨‹åºæ·»åŠ åŸ‹ç‚¹ï¼š[Define custom events](https://developer.android.com/topic/performance/tracing/custom-events)

æ·»åŠ å¥½åï¼Œä½¿ç”¨å®ƒæŠ“åˆ°çš„ç»“æœå¦‚ä¸‹å›¾ï¼š

![systrace](/data/2020-06-03-18-46-34.png)

è¿™é‡Œå¯ä»¥æ‰¾åˆ°æˆ‘ä»¬ä¹‹å‰å…³æ³¨çš„ `Choreographer#doFrame`:

![systrace2](/data/2020-06-03-19-46-03.png)

å¯ä»¥çœ‹åˆ°å¤§é‡çš„æ—¶é—´éƒ½å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œä¸”ç­‰å¾…ä¸»è¦ä½äº `draw` è°ƒç”¨ä¸­ï¼Œ `draw` ä¸»è¦è¿›è¡Œä»¥ä¸‹åŠ¨ä½œï¼š

```java
// frameworks/base/core/java/android/view/ViewRootImpl.java
private void performDraw() {
  // ...
  Trace.traceBegin(Trace.TRACE_TAG_VIEW, "draw");

  try {
      boolean canUseAsync = draw(fullRedrawNeeded);
      if (usingAsyncReport && !canUseAsync) {
          mAttachInfo.mThreadedRenderer.setFrameCompleteCallback(null);
          usingAsyncReport = false;
      }
  } finally {
      mIsDrawing = false;
      Trace.traceEnd(Trace.TRACE_TAG_VIEW);
  }
  // ...
}
```

æ ¹æ®åå­—ï¼Œå¤§æ¦‚çŒœæµ‹ draw è¦è¿›è¡Œç»˜åˆ¶æ“ä½œï¼Œè€Œç»˜åˆ¶å°±ä¼šæ¶‰åŠ GPU è°ƒç”¨ï¼Œå¦‚æœæ˜¯è¿™æ ·å°±å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆ`Choreographer#doFrame`ä¼šæœ‰å¤§é‡çš„ CPU ç­‰å¾…ï¼Œè¿™ä¼¼ä¹æ˜¯åˆç†çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ›´æ–°ä¸€ä¸‹ SufaceView ä¼šå¯¼è‡´ UI çº¿ç¨‹å¤§é‡çš„ç»˜åˆ¶å‘¢ï¼Ÿæ ¹æ®ä¹‹å‰å¯¹ Android æ¸²æŸ“çš„äº†è§£ä»¥åŠå¯¹æ¸²æŸ“æ¶æ„è®¾è®¡çš„ç†è§£ï¼ŒSurfaceView çš„ç»˜åˆ¶åº”è¯¥æ˜¯ç‹¬ç«‹äº UI ä¹‹å¤–è¿›è¡Œçš„ï¼Œå¦åˆ™ SurfaceView çš„è®¾è®¡å°±å¤±å»äº†å®ƒçš„åˆè¡·ï¼Œæ ¹æ®æˆ‘çš„ç†è§£ï¼ŒSurfaceView è®¾è®¡æœ¬æ„å°±æ˜¯è¦å…è®¸ç”¨æˆ·è‡ªå·±æ§åˆ¶ç»˜åˆ¶ï¼Œå…è®¸å®ƒè„±ç¦» UI çº¿ç¨‹ï¼Œä»è€Œæä¾›ç»™ç”¨æˆ·è¾ƒä½çº§åˆ« UI æ§åˆ¶æ‰‹æ®µï¼Œè€Œä¸”æˆ‘çš„ç¨‹åºæ˜¯åœ¨ç‹¬ç«‹çš„`DemoRender`çº¿ç¨‹ä¸­è¿›è¡Œç»˜åˆ¶çš„ï¼Œå°±æ›´ä¸åº”è¯¥å ç”¨å¤§é‡çš„ UI çº¿ç¨‹çš„ã€‚ç¨‹åºä¸­å”¯ä¸€æ›´æ–° UI çš„åœ°æ–¹å°±æ˜¯å¸§ç‡çš„æ˜¾ç¤ºäº†ï¼Œäºæ˜¯æŠŠä»–å»æ‰ï¼Œå†æ¬¡æŠ“å– systraceï¼Œå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š

![systrace3](/data/2020-06-04-11-04-30.png)

å¯ä»¥çœ‹åˆ°ï¼ŒUI çº¿ç¨‹é—²ä¸‹æ¥äº†ï¼Œè€Œä¸”åœ¨æ¯ä¸€ä¸ª vsync ä¿¡å·ä¸­éƒ½éå¸¸ç¨³å®šçš„è§¦å‘`Choreographer#doFrame`ï¼Œè€Œä¸”æ²¡æœ‰äº†å¤§é‡çš„ Off-CPU æ—¶é—´ã€‚

å±€éƒ¨æ”¾å¤§ï¼š

![systrace4](/data/2020-06-04-11-00-37.png)

æ­¤æ—¶ï¼Œæ¯ä¸ª`doFrame`ä¸­ä¹Ÿæ²¡æœ‰äº†`draw`è°ƒç”¨ï¼Œè¿™è¯å®äº†æˆ‘ä»¬ä¹‹å‰çš„ç†è§£æ˜¯æ­£ç¡®çš„ï¼Œ`draw`è°ƒç”¨æ˜¯åœ¨æ›´æ–° TextView ä¸­çš„ fps æ˜¾ç¤ºï¼Œè™½ç„¶ç»“æœå·²ç»æ˜¯è¿™æ ·äº†ï¼Œä½†æ˜¯ä¹‹å‰çœŸæ²¡æƒ³åˆ°ç®€å•çš„ TextView çš„å†…å®¹æ›´æ–°å°±å¯ä»¥è®© UI çº¿ç¨‹ç¹å¿™åˆ°è¿™ç§ç¨‹åº¦ã€‚

å†æ¥çœ‹ä¸€ä¸‹ç»Ÿè®¡æ•°æ®ï¼š

![systrace5](/data/2020-06-04-11-23-28.png)

å¯ä»¥çœ‹åˆ° `doFrame` æ‰§è¡Œäº† 43 æ¬¡ï¼Œ`OnRenderOnRenderThread` æ‰§è¡Œäº† 37 æ¬¡ï¼Œç”±äºåœ¨demoä¸­ `doFrame` åœ¨æ¯ä¸ª vsync çš„æ—¶å€™éƒ½è§¦å‘äº†ï¼Œå› æ­¤å®ƒçš„é€Ÿåº¦æ˜¯ 60fpsï¼Œ`37/43*60=51.6fps`ï¼Œå› æ­¤ï¼Œdemoä¸­ SurfaceView çš„åˆ·æ–°é€Ÿåº¦åªæœ‰ 51fpsï¼Œè™½ç„¶æœ‰äº†å¾ˆå¤§çš„æå‡ï¼Œä½†æ˜¯ç¦» 60fps è¿˜æ˜¯æœ‰ä¸€å®šçš„å·®è·ï¼Œæ³¨æ„åˆ°`DemoRender`çº¿ç¨‹è¿˜æœ‰ä¸€å®šçš„ç©ºé—²æ—¶é—´ï¼Œå¦‚æœæŠŠè¿™äº›æ—¶é—´éƒ½ç”¨èµ·æ¥æ˜¯å¦èƒ½è¾¾åˆ° 60fps å‘¢ï¼Ÿè¿™æ˜¯å¯èƒ½çš„ï¼Œä½†æ˜¯å®é™…é¡¹ç›®ä¸­è¿™æ ·åšçš„æ„ä¹‰ä¸å¤§ï¼Œå› ä¸ºå¯ä»¥æ³¨æ„åˆ°ï¼Œå›¾ä¸­å¾ˆå¤šå¸§çš„ç”Ÿæˆå·²ç»è¶…è¿‡äº† 1 ä¸ª VSYNCï¼Œå³ä½¿å¹³å‡å¸§ç‡èƒ½å¤Ÿè¾¾åˆ° 60fpsï¼Œç”»é¢ä¹Ÿä¸ä¼šå¾ˆæµç•…ã€‚å› ä¸ºæ ¹æœ¬é—®é¢˜æ˜¯è¦ä¿è¯æ¯ä¸€ä¸ª VSYNC æ—¶é—´å†…éƒ½æœ‰æ–°çš„ä¸€å¸§ç”Ÿæˆï¼Œè€Œè¦ä¿è¯è¿™ä¸ªåªèƒ½é€šè¿‡ä¼˜åŒ– GPU è°ƒç”¨æˆ–è€…å‡çº§ GPU ç¡¬ä»¶ã€‚æˆ‘ä»¬æ˜¾ç„¶æ— æ³•æ§åˆ¶ç¡¬ä»¶çš„å‡çº§ï¼Œæ‰€ä»¥åªèƒ½å°è¯•ä¼˜åŒ– GPUï¼ˆGLï¼‰è°ƒç”¨éƒ¨åˆ†ã€‚

è¦ä¼˜åŒ– GL è°ƒç”¨ï¼Œå°±è¦çŸ¥é“å½“å‰å°±è¿›è¡Œäº†å“ªäº›è°ƒç”¨ï¼Œå› ä¸º demo ä¸­ä½¿ç”¨äº† Skia ç»˜å›¾ï¼ˆä¸ºäº†å’Œ chromium ä¿æŒä¸€è‡´ï¼‰ï¼Œæ‰€ä»¥éœ€è¦ç ”ç©¶åœ¨ç»˜åˆ¶çš„æ—¶å€™ Skia ç”Ÿæˆäº†æ€æ ·çš„ GL è°ƒç”¨ã€‚

æ‰€ä»¥åç»­æœ‰å‡ ç§ç­–ç•¥ï¼Œä¸€æ˜¯ä½¿ç”¨ GL è¿›è¡Œç»˜åˆ¶ï¼Œä¸ä½¿ç”¨ Skiaï¼›äºŒæ˜¯ç ”ç©¶ Skia ç”Ÿæˆ GL è°ƒç”¨çš„é€»è¾‘ï¼Œç»™ Skia æ·»åŠ æ—¥å¿—è®°å½•ç”Ÿæˆ GL è°ƒç”¨ï¼ˆå®é™…ä¸ŠSkiaå·²ç»æ·»åŠ äº†è¿™æ ·çš„Traceï¼‰ï¼›ä¸‰æ˜¯é›†æˆ command buffer, ç„¶åå¼€å¯ command buffer çš„è¿½è¸ªï¼›å››æ˜¯æ‰¾åˆ°ä¸€ç§å¯ä»¥è¿½è¸ª GL è°ƒç”¨çš„å·¥å…·ï¼›æœ€åä¸€ç§çœ‹èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä¸šç•Œåº”è¯¥æœ‰ç°æˆçš„è§£å†³æ–¹æ¡ˆã€‚

## GPU Trace

ä¸åƒä»¥ä¸Šä»‹ç»çš„ CPU è°ƒè¯•å·¥å…·é‚£ä¹ˆä¸°å¯Œï¼Œå¯¹äº GPU çš„è°ƒè¯•å¯ä»¥ä½¿ç”¨çš„å·¥å…·æ¯”è¾ƒå°‘ï¼Œç›®å‰ä¸»è¦æœ‰ç³»ç»Ÿè‡ªå¸¦çš„ gpu-rendering æŸ±çŠ¶å›¾ï¼Œè¿™å¯¹äºé—®é¢˜çš„ç²¾ç¡®å®šä½æ˜¯ä¸å¤Ÿçš„ã€‚åœ¨å¾ˆæ—©ä»¥å‰æœ‰ä¸€ä¸ª Android OpenGLES Tracer çš„å·¥å…·å¯ä»¥ç”¨æ¥è¿½è¸ª GL å‡½æ•°çš„è°ƒç”¨ï¼Œä½†ç›®å‰å·²ç»ç”¨ä¸äº†äº†ã€‚

åæ¥ï¼Œåœ¨ç½‘ä¸Šæœç´¢å‘ç° [google/gapid: Graphics API Debugger](https://github.com/google/gapid) æ¯”è¾ƒå¼ºå¤§ï¼Œå®ƒä¸ä»…å¯ä»¥è¿½è¸ª GL çš„æ‰§è¡Œç”šè‡³å¯ä»¥è¿›è¡Œè°ƒç”¨å›æ”¾ï¼Œä¸è¿‡ä»–å·²ç»åœæ­¢å‘å¸ƒæ–°ç‰ˆæœ¬äº†ã€‚è¢«ä¸€ä¸ªæ›´æ–°çš„å·¥å…· [google/agi: Android GPU Inspector](https://github.com/google/agi) å–ä»£ï¼Œä¸è¿‡è¿™ä¸ªå·¥å…·ç›®å‰å¤„äºéå¸¸æ—©æœŸï¼Œç°åœ¨åªæ”¯æŒ Vulkanã€‚

çœ‹èµ·æ¥åªæœ‰ gapid è¿˜èƒ½ç”¨ï¼Œå°è¯•ä½¿ç”¨ gapid æŠ“å– GPU è°ƒç”¨çš„ç»“æœå¦‚ä¸‹ï¼š

![gapid](/data/2020-06-04-15-49-58.png)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ç”»ä¸€æ¡ç¬”è¿¹åæ¯ä¸€å¸§çš„ GL è°ƒç”¨ï¼Œè¿™äº›è°ƒç”¨å¹¶ä¸å¤æ‚ã€‚æ‰€ä»¥å¯èƒ½æ€§èƒ½ç“¶é¢ˆå¹¶ä¸åœ¨è¿™äº›è°ƒç”¨ä¸Šã€‚

ä¸ºäº†éªŒè¯ä»¥ä¸ŠçŒœæƒ³ï¼Œå°è¯•ä¸ä½¿ç”¨ Skia ç»˜å›¾åº“ï¼Œç›´æ¥è°ƒç”¨ OpenGLES è¿›è¡Œç»˜åˆ¶ï¼Œè€Œä¸”åœ¨æ¯ä¸€å¸§ä¸­åªè¿›è¡Œåªè¿›è¡Œç®€å•çš„å¤„ç†ï¼ŒéªŒè¯è¿™æ ·å¸§ç‡æ˜¯å¦èƒ½è¾¾åˆ° 60fpsã€‚

æµ‹è¯•å¾—åˆ°ä»¥ä¸‹ç»“æœï¼š

![single-gl](/data/2020-06-04-19-10-54.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æˆ‘ä»¬é€‰å®šçš„é‚£ä¸€æ®µä¸­ï¼Œ`doFrame`çš„æ•°é‡å’Œ`OnRenderOnRenderThread`çš„æ•°é‡å·²ç»ç›¸ç­‰äº†ï¼Œè¿™è¡¨ç¤ºç¡®å®è¾¾åˆ°äº† 60fps! è¯´å®è¯ï¼Œå½“æ—¶ç¡®å®æœ‰ 5 ç§’é’Ÿçš„å…´å¥‹ï¼Œä¼¼ä¹å‘ç°äº†å®ç° 60fps çš„ä¸€ç§å¯èƒ½çš„æ–¹æ³•ï¼Œä½†å…¶å®äº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œä»å®é™…çš„ä½“éªŒä¸Šæ¥è¯´ï¼Œæ‰‹æŒ‡å’Œç”»å‡ºæ¥çš„ç¬”è¿¹ä¹‹é—´ä¾ç„¶æœ‰æ˜æ˜¾çš„å»¶è¿Ÿï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ—¢ç„¶ç¨‹åºéƒ½å®ç°äº† 60fps ä¸ºä»€ä¹ˆè¿˜ä¼šæœ‰æ˜æ˜¾çš„å»¶è¿Ÿå‘¢ï¼Ÿå…¶å®æ ¹æ®å¯¹ Android æ¸²æŸ“çš„ç†è§£ï¼Œè¿™é‡Œæ˜¯æ¯”è¾ƒå¥½è§£é‡Šçš„ï¼Œå› ä¸ºç¨‹åºç»˜åˆ¶çš„ç»“æœè¦äº¤ç»™ SurfaceFlinger å»åˆæˆï¼Œä¹‹åæ‰ä¼šæœ€ç»ˆæ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬æŸ¥ä¸€ä¸‹ SurfaceFlinger çš„åˆæˆæƒ…å†µï¼Œå¦‚ä¸‹å›¾ï¼š

![surfaceflinger](/data/2020-06-04-19-21-12.png)

å›¾ä¸­ `doComposition` æ“ä½œå³ä¸º SurfaceFlinger åœ¨è¿›è¡Œåˆæˆï¼ˆå…¶å®åç»­è¿˜æœ‰ HWC åˆæˆï¼Œè¿™ä¸æ˜¯é‡ç‚¹ï¼Œå…ˆå¿½ç•¥è¿™ä¸ªï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æ¯æ¬¡è°ƒç”¨å‡ ä¹æ¶ˆè€—äº† 33msï¼Œè¿™ç›´æ¥å¯¼è‡´æœ€ç»ˆçš„æ˜¾ç¤ºåªèƒ½æœ‰å¤§æ¦‚ 30fps çš„åˆ·æ–°ç‡ï¼

## ç»“è®º

åˆ°è¿™é‡Œï¼Œé—®é¢˜å·²ç»æ¯”è¾ƒæ˜æœ—äº†ï¼Œå—é™äºç³»ç»Ÿçš„åˆæˆé€Ÿåº¦ï¼Œæ— æ³•åœ¨ä¸ç»•è¿‡ç³»ç»Ÿåˆæˆçš„æƒ…å†µä¸‹å®ç° 60fps çš„æ¸²æŸ“é€Ÿåº¦ã€‚è€Œè¦ç»•è¿‡ç³»ç»Ÿçš„åˆæˆå±‚ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥ä½¿ç”¨ç³»ç»Ÿçš„ FrameBuffer æ¥å®ç°ï¼Œä½†è¿™ç§æ–¹å¼æ˜¯ä¸é€šç”¨çš„ï¼Œåªèƒ½åœ¨å¼€æ”¾äº†ç›´æ¥æ“ä½œ FrameBuffer çš„è®¾å¤‡ä¸Šæˆ–è€…å°†åº”ç”¨é›†æˆåˆ°ç³»ç»Ÿä¸­ã€‚æ‰€ä»¥ï¼Œè¦æƒ³å½»åº•è§£å†³æ­¤ç±»é—®é¢˜ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯å¯¹ç³»ç»Ÿè¿›è¡Œä¼˜åŒ–ã€‚ç°é˜¶æ®µå¯ä»¥ä½¿ç”¨ç›´æ¥æ“ä½œ FrameBuffer çš„æ–¹æ³•æ¥ç»•è¿‡è¿™ä¸ªé—®é¢˜ã€‚

> å‚è€ƒé“¾æ¥ï¼š
>
> * [Overview of system tracing](https://developer.android.com/topic/performance/tracing)
> * [Define custom events](https://developer.android.com/topic/performance/tracing/custom-events)
> * [Inspect CPU activity with CPU Profiler](https://developer.android.com/studio/profile/cpu-profiler#method_traces)
> * [Trace](https://developer.android.com/reference/android/os/Trace)
> * [Capture a system trace on the command line](https://developer.android.com/topic/performance/tracing/command-line#app-trace)
> * [Debug](https://developer.android.com/reference/android/os/Debug)
> * [Generate Trace Logs by Instrumenting Your App](https://developer.android.com/studio/profile/generate-trace-logs)
> * [Tracing Window Transitions](https://source.android.com/devices/graphics/tracing-win-transitions)
> * [Android Graphics Pipeline: From Button to Framebuffer (Part 1)](https://www.inovex.de/blog/android-graphics-pipeline-from-button-to-framebuffer-part-1/)
> * [VSYNC](https://source.android.com/devices/graphics/implement-vsync)
> * [Graphics architecture](https://source.android.com/devices/graphics/architecture)

---------------------------------

ä»¥ä¸‹æ˜¯èµ°è¿‡çš„ä¸€äº›å¼¯è·¯ï¼Œæƒå½“æ˜¯èŠ±çµ®äº†ã€‚

## å¼¯è·¯

å®é™…ä¸­æ²¡æœ‰ä¸Šé¢é‚£ä¹ˆé¡ºåˆ©ï¼Œä¸‹é¢æ˜¯èµ°è¿‡çš„ä¸€äº›å¼¯è·¯ã€‚

å½“æ—¶ä¸è®¤ä¸ºæ˜¯è‡ªå·±ç¨‹åºä¸­çš„ fps ç»Ÿè®¡å¯¼è‡´`doFrame`çš„å¤§é‡å»¶æ—¶ï¼Œå› ä¸ºä¸å¤ªç›¸ä¿¡ä¸€ä¸ªç®€å•çš„æ–‡æœ¬æ›´æ–°ä¼šå¯¼è‡´å¸§ç‡é™ä½ä¸€åŠï¼Œå› æ­¤è™½ç„¶æŠŠç¨‹åºä¸­çš„ fps åˆ·æ–°ç»™å»æ‰äº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å†æ¬¡æŠ“ systraceï¼Œè¿™å°±å¯¼è‡´èµ°äº†å¼¯è·¯ã€‚

æ‰€ä»¥ï¼Œåé¢åˆæœ‰ä¸¤æ–¹é¢çš„å°è¯•ï¼Œä¸€ä¸ªæ˜¯æƒ³æ˜¯å¦æœ‰åŠæ³•è®© SurfaceView ç‹¬ç«‹è¿›è¡Œç»˜åˆ¶ï¼Œä¸è¦å½±å“ view çš„å¸ƒå±€åŠé‡ç»˜åˆ¶ï¼Œç»è¿‡æœç´¢æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœè¦å›ç­”è¿™ä¸ªé—®é¢˜éœ€è¦å¯¹ Android UI çš„ç»˜åˆ¶åŸç†æœ‰è¶³å¤Ÿçš„äº†è§£ï¼Œè€Œè¿™å¯èƒ½éœ€è¦èŠ±è´¹ä¸€åœ°çš„æ—¶é—´ï¼Œå› æ­¤å…ˆæ”¾ä¸‹ï¼Œç•™ä¸ª TODOã€‚

å› ä¸ºä¹‹å‰è¿˜æ³¨æ„åˆ°ä¸€ä¸ª CPU Profiler çš„è°ƒè¯•å·¥å…·ï¼Œè€Œèµ·çœ‹èµ·æ¥æ›´åŠ å¼ºå¤§ä¸€ç‚¹ï¼Œå› æ­¤æ‰“ç®—å†è¯•ä¸€ä¸‹è¿™ä¸ªå·¥å…·ã€‚

### CPU Profiler (Trace logs)

å¯ä»¥åœ¨ Android Studio ä¸­ç›´æ¥ä½¿ç”¨ CPU Profiler å®æ—¶æŸ¥çœ‹ç¨‹åºçš„è¿è¡Œæƒ…å†µï¼ˆè¦æ±‚ç¨‹åº debugable=trueï¼‰ã€‚ä¹Ÿå¯ä»¥åœ¨ç¨‹åºä¸­ä½¿ç”¨ `android.os.Debug` ç±»å¯åŠ¨è¿½è¸ªï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ª .trace æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥è¢« CPU Profiler åŠ è½½ï¼ˆæˆ–è€…ä½¿ç”¨ `dmtracedump` å·¥å…·å°† .trace æ–‡ä»¶ç”Ÿæˆä¸€ä¸ªè°ƒç”¨å †æ ˆå›¾ï¼‰ã€‚åœ¨å¼€å‘è°ƒè¯•æœŸ CPU Prefiler æ¯”è¾ƒå¥½ç”¨ï¼Œé™¤äº†æœ‰ systrace çš„åŠŸèƒ½ä¹‹å¤–ï¼Œä¹Ÿæ”¯æŒå…¶ä»–æ¯”å¦‚å†…å­˜ï¼Œè€—ç”µç­‰çš„è¿½è¸ªã€‚

è¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•è§ï¼š <https://developer.android.com/studio/profile/cpu-profiler#configurations>

åœ¨å®é™…ä¸­ï¼Œæ‰“å¼€è¿™ä¸ªå·¥å…·åï¼Œé‡åˆ°æ— æ³•æ£€æµ‹åˆ° demo ç¨‹åºçš„é—®é¢˜ï¼Œå°è¯•äº†å‡çº§ AndroidStudioï¼Œå‡çº§ SDKï¼Œç»™ç¨‹åºçš„`AndroidManifest.xml`æ–‡ä»¶æ·»åŠ `android:debuggable="true"`, é‡å¯ AndroidStudio ä¹‹åï¼Œç»ˆäºèƒ½å¤ŸæˆåŠŸæ£€æµ‹åˆ° demo ç¨‹åºäº†ï¼Œä¸‹å›¾æ˜¯ä½¿ç”¨ CPU Profiler æŠ“åˆ°çš„ç¨‹åºè¿è¡Œæƒ…å†µï¼š

> ä»¥ä¸Šé—®é¢˜æ˜¯å› ä¸º demo ç¨‹åºæ²¡æœ‰ä½¿ç”¨ AndroidStudio ä»¥åŠ gradle è¿›è¡Œå¼€å‘ï¼Œè€Œæ˜¯ä½¿ç”¨äº† chromium çš„ Android Apk ç¼–è¯‘å·¥å…·é“¾ï¼Œå¦‚æœä½¿ç”¨ AndroidStudio è¿›è¡Œå¼€å‘å¯èƒ½å°±ä¼šè½»æ¾ä¸€ç‚¹ï¼Œå½“ç„¶ä½¿ç”¨ chromium å·¥å…·é“¾çš„å¥½å¤„å°±æ˜¯å¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨ chromium å¥—ä»¶ï¼Œè€Œä¸”å¯ä»¥ä¸ç”¨æ‰“å¼€åºå¤§çš„ IDE ğŸ¶.

![tracelog](/data/2020-06-04-09-53-22.png)

è¿™é‡Œå¯ä»¥å‘ç°ï¼Œåœ¨`Choreographer#doFrame`ä¸­åªæœ‰ input çš„å¤„ç†ï¼Œæ²¡æœ‰ traversal/draw çš„ç›¸å…³è°ƒç”¨ï¼Œæ­¤æ—¶ç»ˆäºæç„¶å¤§æ‚Ÿï¼Œå›åˆ°äº†æ­£è½¨ï¼ŒåŸæ¥çœŸæ˜¯ TextView çš„æ›´æ–°å¯¼è‡´çš„å»¶æ—¶ã€‚

å¦å¤–ï¼ŒCPU Profiler ä¹Ÿå¯ä»¥æä¾›ä¸€äº› systrace æ²¡æœ‰æä¾›çš„ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨ draw ä¹‹åå®ƒä¼šå‘Šè¯‰ä½ æ˜¯åœ¨ç­‰å¾… GPUã€‚

åæ¥åˆå‘ç° simpleperf å·¥å…·ï¼Œä½†æ˜¯ä»–å¯¹æˆ‘ä»¬çš„é—®é¢˜åˆ†æå¸®åŠ©ä¸å¤§ï¼Œæ‰€ä»¥åœ¨äº†è§£åæ²¡æœ‰è¿›ä¸€æ­¥çš„å°è¯•ã€‚

### simpleperf

å®ƒç±»ä¼¼ linux ä¸Šçš„ perf å·¥å…·ï¼Œå¯ä»¥æ”¶é›† Java/C++å±‚ç¨‹åºæ‰§è¡Œçš„çƒ­ç‚¹å‡½æ•°åŠè°ƒç”¨å †æ ˆï¼Œé…åˆ FlameGraph ç”Ÿæˆç«ç„°å›¾ã€‚

å…³äºå®ƒçš„è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒï¼š[Android application profiling](https://android.googlesource.com/platform/system/extras/+/master/simpleperf/doc/android_application_profiling.md)

> å…³äºæ€§èƒ½è°ƒè¯•çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡æ¡£ï¼š
>
> * [Slow rendering](https://developer.android.com/topic/performance/vitals/render)
> * [Overview of system tracing](https://developer.android.com/topic/performance/tracing)
> * [Tracing Window Transitions](https://source.android.com/devices/graphics/tracing-win-transitions)

### dumpsys

`dumpsys` æ˜¯ä¸€ä¸ªå†…ç½®åœ¨ç³»ç»Ÿå†…çš„å·¥å…·ï¼Œå®ƒå¯ä»¥è·å–ç³»ç»Ÿserviceçš„çŠ¶æ€ä¿¡æ¯ï¼Œå…·ä½“ç”¨æ³•è§ [dumpsys](https://developer.android.com/studio/command-line/dumpsys).

ä½¿ç”¨ `dumpsys` è·å–æ¸²æŸ“ä¿¡æ¯ï¼š

```text
$ adb shell dumpsys gfxinfo org.demo.demo_android_skia
Applications Graphics Acceleration Info:
Uptime: 193498680 Realtime: 193498680

** Graphics info for pid 9163 [org.demo.demo_android_skia] **

Stats since: 125971681353608ns
Total frames rendered: 25
Janky frames: 7 (28.00%)
50th percentile: 11ms
90th percentile: 73ms
95th percentile: 350ms
99th percentile: 450ms
Number Missed Vsync: 2
Number High input latency: 0
Number Slow UI thread: 7
Number Slow bitmap uploads: 1
Number Slow issue draw commands: 2
HISTOGRAM: 5ms=1 6ms=3 7ms=4 8ms=0 9ms=3 10ms=1 11ms=2 12ms=1 13ms=1 14ms=1 15ms=1 16ms=0 17ms=0 18ms=0 19ms=0 20ms=0 21ms=0 22ms=1 23ms=0 24ms=0 25ms=0 26ms=1 27ms=0 28ms=0 29ms=0 30ms=0 31ms=0 32ms=1 34ms=0 36ms=0 38ms=1 40ms=0 42ms=0 44ms=0 46ms=0 48ms=0 53ms=0 57ms=0 61ms=0 65ms=0 69ms=0 73ms=1 77ms=0 81ms=0 85ms=0 89ms=0 93ms=0 97ms=0 101ms=0 105ms=0 109ms=0 113ms=0 117ms=0 121ms=0 125ms=0 129ms=0 133ms=0 150ms=0 200ms=0 250ms=0 300ms=0 350ms=1 400ms=0 450ms=1 500ms=0 550ms=0 600ms=0 650ms=0 700ms=0 750ms=0 800ms=0 850ms=0 900ms=0 950ms=0 1000ms=0 1050ms=0 1100ms=0 1150ms=0 1200ms=0 1250ms=0 1300ms=0 1350ms=0 1400ms=0 1450ms=0 1500ms=0 1550ms=0 1600ms=0 1650ms=0 1700ms=0 1750ms=0 1800ms=0 1850ms=0 1900ms=0 1950ms=0 2000ms=0 2050ms=0 2100ms=0 2150ms=0 2200ms=0 2250ms=0 2300ms=0 2350ms=0 2400ms=0 2450ms=0 2500ms=0 2550ms=0 2600ms=0 2650ms=0 2700ms=0 2750ms=0 2800ms=0 2850ms=0 2900ms=0 2950ms=0 3000ms=0 3050ms=0 3100ms=0 3150ms=0 3200ms=0 3250ms=0 3300ms=0 3350ms=0 3400ms=0 3450ms=0 3500ms=0 3550ms=0 3600ms=0 3650ms=0 3700ms=0 3750ms=0 3800ms=0 3850ms=0 3900ms=0 3950ms=0 4000ms=0 4050ms=0 4100ms=0 4150ms=0 4200ms=0 4250ms=0 4300ms=0 4350ms=0 4400ms=0 4450ms=0 4500ms=0 4550ms=0 4600ms=0 4650ms=0 4700ms=0 4750ms=0 4800ms=0 4850ms=0 4900ms=0 4950ms=0

Caches:
Current memory usage / total memory usage (bytes):
  TextureCache            28800 / 134217728
  Layers total          0 (numLayers = 0)
  RenderBufferCache           0 /  2097152
  GradientCache               0 /   524288
  PathCache                   0 /  4194304
  TessellationCache           0 /  1048576
  TextDropShadowCache         0 /  2097152
  PatchCache                192 /   131072
  FontRenderer A8         53983 /   524288
    A8   texture 0        53983 /   524288
  FontRenderer RGBA           0 /        0
  FontRenderer total      53983 /   524288
Other:
  FboCache                    0 /        0
Total memory usage:
  553280 bytes, 0.53 MB


Pipeline=FrameBuilder
Profile data in ms:

        org.demo.demo_android_skia/org.demo.demo_android_skia.DemoAndroidSkiaActivity/android.view.ViewRootImpl@cf7a43c (visibility=8)
        Draw    Prepare Process Execute

View hierarchy:

  org.demo.demo_android_skia/org.demo.demo_android_skia.DemoAndroidSkiaActivity/android.view.ViewRootImpl@cf7a43c
  23 views, 23.67 kB of display lists


Total ViewRootImpl: 1
Total Views:        23
Total DisplayList:  23.67 kB
```
